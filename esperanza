#!/bin/bash

#################################################
# Script:    esperanza                          #
# Author:    Leonardo Costa                     #
# Contact:   lccoder.php@gmail.com              #
# Created:   2015-12-29 01:35:37 AM             #
# Version:   2.0                                #
# Description: Video converter using ffmpeg     #
# Supports Ubuntu/Debian and Fedora             #
#################################################

# Function to install ffmpeg if missing
install_ffmpeg() {
    if type ffmpeg >/dev/null 2>&1; then
        return
    fi

    echo "ffmpeg is not installed. Attempting to install..."

    if type dnf >/dev/null 2>&1; then
        su root -c "dnf install ffmpeg -y"
    elif type apt-get >/dev/null 2>&1; then
        sudo apt-get update
        sudo apt-get install ffmpeg -y
    else
        echo "Error: Package manager not found. Install ffmpeg manually."
        exit 1
    fi

    if ! type ffmpeg >/dev/null 2>&1; then
        echo "Error: ffmpeg installation failed."
        exit 1
    fi
}

# Install ffmpeg if not present
install_ffmpeg

# Validate arguments
if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Usage: $0 <input_file> <output_file_name> [output_format]"
    echo "Example: $0 input.avi output mp4"
    exit 1
fi

INPUT_FILE="$1"
OUTPUT_NAME="$2"
OUTPUT_FORMAT="${3:-mp4}"  # Default format is mp4

# Perform the conversion
ffmpeg -i "$INPUT_FILE" -c:v libx264 -strict -2 "$OUTPUT_NAME.$OUTPUT_FORMAT"

# Check if conversion succeeded
if [ $? -eq 0 ]; then
    echo "The file '$OUTPUT_NAME.$OUTPUT_FORMAT' was successfully generated!"
    exit 0
else
    echo "An error occurred while generating '$OUTPUT_NAME.$OUTPUT_FORMAT'."
    exit 1
fi
